name: Lint

on:
  workflow_call:

jobs:
  lint:
    name: Lint (${{ matrix.os }})
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        # Windows doesn't get to be linted continuously because it annoyingly requires
        # that all files use \r\n line endings.
        # macOS only on main â€” no darwin-specific Go files exist (all OS splits are unix/windows).
        os: ${{ github.ref == 'refs/heads/main' && fromJSON('["ubuntu","macos"]') || fromJSON('["ubuntu"]') }}

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

    - name: "Mount tmpfs on /tmp for faster I/O"
      if: runner.os == 'Linux'
      run: |
        sudo mount -t tmpfs -o size=12G,mode=1777 tmpfs /tmp
        echo "tmpfs mounted on /tmp:"
        df -h /tmp

    - name: Set up mise
      uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3
      with:
        version: 2026.1.9
        experimental: true
      env:
        # Adding token here to reduce the likelihood of hitting rate limit issues.
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - id: go-cache-paths
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          # Use tmpfs-backed paths for faster cache I/O
          echo "go-build=/tmp/cache/go-build" >> "$GITHUB_OUTPUT"
          echo "go-mod=/tmp/cache/go-mod" >> "$GITHUB_OUTPUT"
          echo "golangci-lint-cache=/tmp/cache/golangci-lint" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "go-build=$(go env GOCACHE)" >> "$GITHUB_OUTPUT"
        echo "go-mod=$(go env GOMODCACHE)" >> "$GITHUB_OUTPUT"

        if [ "$RUNNER_OS" == "Windows" ]; then
          echo "golangci-lint-cache=$LOCALAPPDATA/golangci-lint" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        if [ "$RUNNER_OS" == "macOS" ]; then
          echo "golangci-lint-cache=$HOME/Library/Caches/golangci-lint" >> "$GITHUB_OUTPUT"
          exit 0
        fi

    - name: Restore lint caches
      uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
      with:
        path: |
          ${{ steps.go-cache-paths.outputs.go-build }}
          ${{ steps.go-cache-paths.outputs.go-mod }}
          ${{ steps.go-cache-paths.outputs.golangci-lint-cache }}
        key: ${{ runner.os }}-lint-${{ hashFiles('**/go.sum') }}-${{ matrix.os }}
        restore-keys: |
          ${{ runner.os }}-lint-

    - name: Download Go modules
      env:
        GOMODCACHE: ${{ steps.go-cache-paths.outputs.go-mod }}
      run: go mod download

    - name: Fetch main for incremental lint
      if: github.ref != 'refs/heads/main'
      run: git fetch origin main --depth=1

    - name: Lint
      env:
        GOCACHE: ${{ steps.go-cache-paths.outputs.go-build }}
        GOMODCACHE: ${{ steps.go-cache-paths.outputs.go-mod }}
        GOLANGCI_LINT_CACHE: ${{ steps.go-cache-paths.outputs.golangci-lint-cache }}
      run: |
        if [ "${{ github.ref }}" != "refs/heads/main" ]; then
          BASE_REV=$(git merge-base origin/main HEAD) make run-lint-incremental
        else
          make run-lint
        fi

    - name: Save lint caches
      if: always()
      uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
      with:
        path: |
          ${{ steps.go-cache-paths.outputs.go-build }}
          ${{ steps.go-cache-paths.outputs.go-mod }}
          ${{ steps.go-cache-paths.outputs.golangci-lint-cache }}
        key: ${{ runner.os }}-lint-${{ hashFiles('**/go.sum') }}-${{ matrix.os }}
