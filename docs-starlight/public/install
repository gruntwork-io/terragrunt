#!/usr/bin/env bash
# Terragrunt Installer
#
# Supported platforms: Linux, macOS (Darwin)
# Supported architectures: x86_64 (amd64), aarch64/arm64, i386/i686 (386)
# Requirements: bash 3.2+, curl, sha256sum or shasum
#
# Note: This script requires bash (not sh) for:
#   - pipefail option (set -o pipefail)
#   - local variables in functions
#   - [[ ]] test syntax
#   - arrays and readonly declarations
#
# Usage:
#   curl -sL https://terragrunt.gruntwork.io/install.sh | bash
#   curl -sL https://terragrunt.gruntwork.io/install.sh | bash -s -- -v v0.72.5
#   curl -sL https://terragrunt.gruntwork.io/install.sh | bash -s -- -d ~/bin
#
# Options:
#   -v, --version VERSION    Install specific version (default: latest)
#   -d, --dir PATH           Installation directory (default: /usr/local/bin)
#   -f, --force              Overwrite existing installation
#   --verify-sig             Verify signature (auto-detect gpg/cosign)
#   --verify-gpg             Verify GPG signature (requires gpg)
#   --verify-cosign          Verify Cosign signature (requires cosign)
#   --no-verify-sig          Skip signature verification
#   --no-verify              Skip checksum verification
#   -h, --help               Show this help message
#
# Environment:
#   TERRAGRUNT_VERSION       Override version (same as -v)
#   TERRAGRUNT_INSTALL_DIR   Override install directory (same as -d)

set -euo pipefail

# --- Constants ---
readonly GITHUB_REPO="gruntwork-io/terragrunt"
readonly GPG_KEY_URL="https://gruntwork.io/.well-known/pgp-key.txt"
readonly DEFAULT_INSTALL_DIR="/usr/local/bin"
readonly BINARY_NAME="terragrunt"
# Minimum version that has signed release assets (GPG and Cosign)
readonly MIN_SIGNED_VERSION="0.98.0"

# --- Colors (if terminal) ---
# Use $'...' syntax for reliable escape sequence interpretation on macOS/Linux
if [[ -t 1 ]]; then
    readonly RED=$'\033[0;31m'
    readonly GREEN=$'\033[0;32m'
    readonly YELLOW=$'\033[0;33m'
    readonly BLUE=$'\033[0;34m'
    readonly NC=$'\033[0m' # No Color
else
    readonly RED=''
    readonly GREEN=''
    readonly YELLOW=''
    readonly BLUE=''
    readonly NC=''
fi

# --- Helper Functions ---
abort() {
    printf "${RED}Error: %s${NC}\n" "$1" >&2
    exit 1
}

info() {
    printf "${BLUE}==> ${NC}%s\n" "$1"
}

warn() {
    printf "${YELLOW}Warning: %s${NC}\n" "$1" >&2
}

success() {
    printf "${GREEN}==> %s${NC}\n" "$1"
}

usage() {
    cat <<EOF
Terragrunt Installer

Usage:
  curl -sL https://terragrunt.gruntwork.io/install.sh | bash
  curl -sL https://terragrunt.gruntwork.io/install.sh | bash -s -- [OPTIONS]

Options:
  -v, --version VERSION    Install specific version (default: latest)
  -d, --dir PATH           Installation directory (default: /usr/local/bin)
  -f, --force              Overwrite existing installation
  --verify-sig             Verify signature (auto-detect gpg/cosign)
  --verify-gpg             Verify GPG signature (requires gpg)
  --verify-cosign          Verify Cosign signature (requires cosign)
  --no-verify-sig          Skip signature verification
  --no-verify              Skip checksum verification
  -h, --help               Show this help message

Examples:
  # Install latest version
  curl -sL https://terragrunt.gruntwork.io/install.sh | bash

  # Install specific version
  curl -sL https://terragrunt.gruntwork.io/install.sh | bash -s -- -v v0.72.5

  # Install to custom directory
  curl -sL https://terragrunt.gruntwork.io/install.sh | bash -s -- -d ~/bin

  # Install with signature verification (auto-detect gpg/cosign)
  curl -sL https://terragrunt.gruntwork.io/install.sh | bash -s -- --verify-sig
EOF
}

# --- Version Comparison ---
# Compare two semantic versions. Returns 0 if $1 >= $2, 1 otherwise.
version_gte() {
    local version=$1
    local min_version=$2

    # Strip 'v' prefix if present
    version="${version#v}"
    min_version="${min_version#v}"

    # Use sort -V if available, otherwise fall back to manual comparison
    if echo | sort -V >/dev/null 2>&1; then
        local sorted_first
        sorted_first=$(printf '%s\n%s' "$min_version" "$version" | sort -V | head -n1)
        [[ "$sorted_first" == "$min_version" ]]
    else
        # Manual version comparison for systems without sort -V (e.g., older macOS)
        local i
        local IFS='.'
        read -ra v1 <<<"$version"
        read -ra v2 <<<"$min_version"

        for ((i = 0; i < ${#v2[@]}; i++)); do
            local n1=${v1[i]:-0}
            local n2=${v2[i]:-0}
            if ((n1 > n2)); then
                return 0
            elif ((n1 < n2)); then
                return 1
            fi
        done
        return 0
    fi
}

# Check if version supports signature verification
supports_signature_verification() {
    local version=$1
    version_gte "$version" "$MIN_SIGNED_VERSION"
}

# --- OS/Arch Detection ---
detect_os() {
    local os
    os="$(uname -s)"
    case "$os" in
        Darwin) echo "darwin" ;;
        Linux)  echo "linux" ;;
        MINGW*|MSYS*|CYGWIN*)
            abort "Windows detected. Please use PowerShell or install via Chocolatey:
  choco install terragrunt

Or download manually from: https://github.com/gruntwork-io/terragrunt/releases"
            ;;
        *)
            abort "Unsupported operating system: $os
Supported: Linux, macOS (Darwin)"
            ;;
    esac
}

detect_arch() {
    local arch
    arch="$(uname -m)"
    case "$arch" in
        x86_64|amd64)  echo "amd64" ;;
        aarch64|arm64) echo "arm64" ;;
        i386|i686)     echo "386" ;;
        *)
            abort "Unsupported architecture: $arch
Supported: x86_64 (amd64), aarch64 (arm64), i386/i686 (386)"
            ;;
    esac
}

# --- Version Resolution ---
get_latest_version() {
    local version

    # Method 1: Use redirect URL (higher rate limits than API)
    # GitHub redirects /releases/latest to /releases/tag/vX.Y.Z
    local redirect_url
    if redirect_url=$(curl -fsI "https://github.com/${GITHUB_REPO}/releases/latest" 2>/dev/null | grep -i '^location:' | tr -d '\r'); then
        version=$(echo "$redirect_url" | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1)
        if [[ -n "$version" ]]; then
            echo "$version"
            return 0
        fi
    fi

    # Method 2: Fallback to GitHub API (may hit rate limits: 60 req/hour unauthenticated)
    if version=$(curl -fsL "https://api.github.com/repos/${GITHUB_REPO}/releases/latest" 2>/dev/null | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4); then
        if [[ -n "$version" ]]; then
            echo "$version"
            return 0
        fi
    fi

    abort "Could not determine latest version.
This may be due to GitHub API rate limits (60 requests/hour).
Specify a version manually with -v, e.g.: -v v0.72.5"
}

validate_version() {
    local version="$1"
    # Accept versions with or without 'v' prefix
    if [[ ! "$version" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
        abort "Invalid version format: $version
Expected format: v0.72.5 or 0.72.5"
    fi
    # Ensure version has 'v' prefix
    if [[ ! "$version" =~ ^v ]]; then
        version="v$version"
    fi
    echo "$version"
}

# --- Download Functions ---
download_file() {
    local url="$1"
    local output="$2"
    local description="$3"

    info "Downloading $description..."
    if ! curl -sL --fail "$url" -o "$output" 2>/dev/null; then
        abort "Failed to download $description from: $url"
    fi
}

download_binary() {
    local version="$1"
    local binary_name="$2"
    local output_dir="$3"

    local url="https://github.com/${GITHUB_REPO}/releases/download/${version}/${binary_name}"
    download_file "$url" "${output_dir}/${binary_name}" "Terragrunt ${version}"
}

download_checksums() {
    local version="$1"
    local output_dir="$2"

    local url="https://github.com/${GITHUB_REPO}/releases/download/${version}/SHA256SUMS"
    download_file "$url" "${output_dir}/SHA256SUMS" "checksums"
}

# --- Verification Functions ---
verify_sha256() {
    local binary_path="$1"
    local checksums_path="$2"
    local binary_name="$3"

    info "Verifying SHA256 checksum..."

    local actual_checksum
    if command -v sha256sum &>/dev/null; then
        actual_checksum=$(sha256sum "$binary_path" | awk '{print $1}')
    elif command -v shasum &>/dev/null; then
        actual_checksum=$(shasum -a 256 "$binary_path" | awk '{print $1}')
    else
        abort "Neither sha256sum nor shasum found. Cannot verify checksum."
    fi

    local expected_checksum
    # Strip CRLF and find checksum for binary
    expected_checksum=$(tr -d '\r' < "$checksums_path" | awk -v bin="$binary_name" '$2 == bin {print $1; exit}')

    if [[ -z "$expected_checksum" ]]; then
        abort "Could not find checksum for $binary_name in SHA256SUMS file"
    fi

    if [[ "$actual_checksum" != "$expected_checksum" ]]; then
        abort "Checksum verification failed!
Expected: $expected_checksum
Got:      $actual_checksum

The downloaded file may be corrupted or tampered with."
    fi
}

verify_gpg() {
    local version="$1"
    local checksums_path="$2"
    local tmpdir="$3"

    local sig_url="https://github.com/${GITHUB_REPO}/releases/download/${version}/SHA256SUMS.gpgsig"
    local sig_path="${tmpdir}/SHA256SUMS.gpgsig"
    local gnupg_home="${tmpdir}/gnupg"

    info "Downloading GPG signature..."
    if ! curl -sL --fail "$sig_url" -o "$sig_path" 2>/dev/null; then
        warn "Failed to download GPG signature file"
        return 1
    fi

    # Create temporary GNUPGHOME to avoid polluting user's keyring
    mkdir -p "$gnupg_home"
    chmod 700 "$gnupg_home"

    info "Importing Gruntwork GPG key..."
    if ! curl -sL "$GPG_KEY_URL" | GNUPGHOME="$gnupg_home" gpg --import 2>/dev/null; then
        warn "Failed to import GPG key"
        return 1
    fi

    info "Verifying GPG signature..."
    if GNUPGHOME="$gnupg_home" gpg --verify "$sig_path" "$checksums_path" 2>/dev/null; then
        return 0
    else
        return 1
    fi
}

verify_cosign() {
    local version="$1"
    local checksums_path="$2"
    local tmpdir="$3"

    local sig_url="https://github.com/${GITHUB_REPO}/releases/download/${version}/SHA256SUMS.sig"
    local cert_url="https://github.com/${GITHUB_REPO}/releases/download/${version}/SHA256SUMS.pem"
    local sig_path="${tmpdir}/SHA256SUMS.sig"
    local cert_path="${tmpdir}/SHA256SUMS.pem"

    info "Downloading Cosign signature files..."
    if ! curl -sL --fail "$sig_url" -o "$sig_path" 2>/dev/null; then
        warn "Failed to download Cosign signature file"
        return 1
    fi
    if ! curl -sL --fail "$cert_url" -o "$cert_path" 2>/dev/null; then
        warn "Failed to download Cosign certificate file"
        return 1
    fi

    info "Verifying Cosign signature..."
    if cosign verify-blob "$checksums_path" \
        --signature "$sig_path" \
        --certificate "$cert_path" \
        --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
        --certificate-identity-regexp "github.com/gruntwork-io/terragrunt" 2>/dev/null; then
        return 0
    else
        return 1
    fi
}

# Verify signature using specified method or auto-detect
verify_signature() {
    local version="$1"
    local checksums_path="$2"
    local tmpdir="$3"
    local method="$4"  # gpg, cosign, or auto

    case "$method" in
        gpg)
            if ! command -v gpg &>/dev/null; then
                abort "GPG verification requested but gpg is not installed"
            fi
            if verify_gpg "$version" "$checksums_path" "$tmpdir"; then
                return 0
            else
                abort "GPG signature verification failed!"
            fi
            ;;
        cosign)
            if ! command -v cosign &>/dev/null; then
                abort "Cosign verification requested but cosign is not installed"
            fi
            if verify_cosign "$version" "$checksums_path" "$tmpdir"; then
                return 0
            else
                abort "Cosign signature verification failed!"
            fi
            ;;
        auto)
            # Try GPG first, then Cosign
            if command -v gpg &>/dev/null; then
                info "Using GPG for signature verification"
                if verify_gpg "$version" "$checksums_path" "$tmpdir"; then
                    return 0
                fi
                warn "GPG verification failed, trying Cosign..."
            fi

            if command -v cosign &>/dev/null; then
                info "Using Cosign for signature verification"
                if verify_cosign "$version" "$checksums_path" "$tmpdir"; then
                    return 0
                fi
            fi

            abort "Signature verification failed. Neither gpg nor cosign succeeded.
Install gpg or cosign, or use --no-verify-sig to skip signature verification."
            ;;
    esac
}

# --- Installation ---
install_binary() {
    local binary_path="$1"
    local install_dir="$2"
    local force="$3"
    local requested_version="$4"

    local target_path="${install_dir}/${BINARY_NAME}"

    # Check if already exists
    if [[ -f "$target_path" && "$force" != "true" ]]; then
        local existing_version
        existing_version=$("$target_path" --version 2>/dev/null | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1 || echo "unknown")

        if [[ "$existing_version" == "$requested_version" ]]; then
            abort "Terragrunt ${existing_version} is already installed at $target_path"
        else
            abort "A different version (${existing_version}) is installed at $target_path
Use --force to upgrade/downgrade to ${requested_version}"
        fi
    fi

    # Check if install directory exists
    if [[ ! -d "$install_dir" ]]; then
        abort "Installation directory does not exist: $install_dir
Create it first or specify a different directory with -d"
    fi

    # Check write permissions
    if [[ ! -w "$install_dir" ]]; then
        abort "Cannot write to $install_dir
Try running with sudo or specify a different directory with -d"
    fi

    info "Installing to ${target_path}..."
    install -m 0755 "$binary_path" "$target_path"
}

# --- Argument Parsing ---
parse_args() {
    # Set defaults from environment or hardcoded values
    VERSION="${TERRAGRUNT_VERSION:-}"
    INSTALL_DIR="${TERRAGRUNT_INSTALL_DIR:-$DEFAULT_INSTALL_DIR}"
    VERIFY_SHA=true
    VERIFY_SIG="auto"  # auto=auto-detect, gpg/cosign=specific, empty=skip
    FORCE=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -v|--version)
                [[ -z "${2:-}" ]] && abort "Option $1 requires a version argument"
                VERSION="$2"
                shift 2
                ;;
            -d|--dir)
                [[ -z "${2:-}" ]] && abort "Option $1 requires a directory argument"
                INSTALL_DIR="$2"
                shift 2
                ;;
            -f|--force)
                FORCE=true
                shift
                ;;
            --verify-sig)
                VERIFY_SIG="auto"
                shift
                ;;
            --verify-gpg)
                VERIFY_SIG="gpg"
                shift
                ;;
            --verify-cosign)
                VERIFY_SIG="cosign"
                shift
                ;;
            --no-verify-sig)
                VERIFY_SIG=""
                shift
                ;;
            --no-verify)
                VERIFY_SHA=false
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            -*)
                abort "Unknown option: $1
Use -h or --help for usage information"
                ;;
            *)
                abort "Unexpected argument: $1
Use -h or --help for usage information"
                ;;
        esac
    done
}

# --- Dependency Check ---
check_dependencies() {
    if ! command -v curl &>/dev/null; then
        abort "curl is required but not installed.
Please install curl and try again."
    fi

    if [[ "$VERIFY_SHA" == true ]]; then
        if ! command -v sha256sum &>/dev/null && ! command -v shasum &>/dev/null; then
            abort "Neither sha256sum nor shasum found.
Install one or use --no-verify to skip checksum verification."
        fi
    fi

    case "$VERIFY_SIG" in
        gpg)
            if ! command -v gpg &>/dev/null; then
                abort "GPG verification requested but gpg is not installed.
Install gpg or use --verify-sig for auto-detection."
            fi
            ;;
        cosign)
            if ! command -v cosign &>/dev/null; then
                abort "Cosign verification requested but cosign is not installed.
Install cosign or use --verify-sig for auto-detection."
            fi
            ;;
        auto)
            if ! command -v gpg &>/dev/null && ! command -v cosign &>/dev/null; then
                abort "Signature verification requested but neither gpg nor cosign is installed.
Install gpg or cosign, or use --no-verify-sig to skip."
            fi
            ;;
    esac
}

# --- Main ---
main() {
    parse_args "$@"

    # Expand tilde in INSTALL_DIR (bash doesn't expand ~ in quoted variables)
    INSTALL_DIR="${INSTALL_DIR/#\~/$HOME}"

    # Check dependencies
    check_dependencies

    # Detect platform
    local os arch version binary_name
    os=$(detect_os)
    arch=$(detect_arch)

    # Resolve version
    if [[ -z "$VERSION" ]]; then
        info "Fetching latest version..."
        version=$(get_latest_version)
    else
        version=$(validate_version "$VERSION")
    fi

    binary_name="terragrunt_${os}_${arch}"

    info "Installing Terragrunt ${version} for ${os}/${arch}"

    # Create temp directory
    local tmpdir
    tmpdir=$(mktemp -d 2>/dev/null || mktemp -d -t 'terragrunt-install')
    trap 'rm -rf "${tmpdir:-}"' EXIT

    # Download files
    download_binary "$version" "$binary_name" "$tmpdir"
    download_checksums "$version" "$tmpdir"

    # Verify checksum
    if [[ "$VERIFY_SHA" == true ]]; then
        verify_sha256 "$tmpdir/$binary_name" "$tmpdir/SHA256SUMS" "$binary_name"
        success "SHA256 checksum verified"
    else
        warn "Skipping checksum verification (--no-verify specified)"
    fi

    # Verify signature (enabled by default for versions >= MIN_SIGNED_VERSION)
    if [[ -n "$VERIFY_SIG" ]]; then
        if supports_signature_verification "$version"; then
            verify_signature "$version" "$tmpdir/SHA256SUMS" "$tmpdir" "$VERIFY_SIG"
            success "Signature verified"
        else
            warn "Skipping signature verification: not available for versions older than v${MIN_SIGNED_VERSION}"
        fi
    else
        warn "Skipping signature verification (--no-verify-sig specified)"
    fi

    # Install
    install_binary "$tmpdir/$binary_name" "$INSTALL_DIR" "$FORCE" "$version"

    success "Terragrunt ${version} installed successfully!"
    echo ""
    echo "Run 'terragrunt --version' to verify the installation."
    echo "For documentation, visit: https://terragrunt.gruntwork.io/docs"
}

main "$@"
